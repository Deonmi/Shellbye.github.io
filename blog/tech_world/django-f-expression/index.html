

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>
      
        Django F expression 实例 -
      
      六系小白
    </title>
    
    <meta name="author" content="shellbye">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link href="/assets/themes/hooligan/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/hooligan/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/assets/themes/hooligan/css-social-buttons/css/zocial.stripped.css">
    <link href="/assets/themes/hooligan/css/pygments.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/darkstrap.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link rel="shortcut icon" href="/assets/favicon.png">
    <link rel="apple-touch-icon" href="/assets/favicon.png">
    <!-- fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->
  </head>

  <body>
    <div id="page-wrap">
      <div class="navbar">
        <div class="navbar-inner">
          <div class="container">
            <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </a>

            <a class="brand" href="/">六系小白</a>

            <div class="nav-collapse">
              <ul class="nav">
                
                
                


  
    
      
      	
      	<li><a href="/archive/">历史记录</a></li>
      	
      
    
  
    
  
    
      
      	
      	<li><a href="/categories/">分类</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/blog/direct-era/">导演时代</a></li>
      	
      
    
  
    
      
    
  
    
  
    
      
      	
      	<li><a href="/blog/poet/">小白的诗</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/blog/small-games/">小游戏</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/tags/">标签</a></li>
      	
      
    
  
    
  
    
  



              </ul>
              <ul class="nav pull-right social visible-desktop">
                <li class="divider-vertical"></li>
                
                <li>
                  <a href="https://github.com/shellbye" class="zocial github icon" target="_blank">
                    <span class="hidden-desktop">Github</span>
                  </a>
                </li>
                
                
                
                
                
                
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="container">
        <div class="content">
          

<div class="page-header">
  <h1>
    Django F expression 实例 
    
  </h1>
</div>

<div class="row">
  <div class="span8">
    <p>之前做项目时，因为对Django的特性不是很熟，所以导致数据库在正常的操作顺序下，因为同步较多而产生过脏数据，后来通过Django的 F 函数解决了同步问题，但是没搞清原理，今天师姐问了下我原理，我就去看了下Django的<a href="https://docs.djangoproject.com/en/dev/ref/models/queries/#django.db.models.F">官方文档</a>，做了个如下的简单实验，真正理解了 F 函数的原理。</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="c1"># models.py</span>
<span class="k">class</span> <span class="nc">Reporters</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">stories_filed</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>




<span class="c1"># views.py</span>
<span class="k">def</span> <span class="nf">diveinto_f</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connection</span>
    <span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">Reporters</span>
    <span class="n">reporter</span> <span class="o">=</span> <span class="n">Reporters</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Tintin&#39;</span><span class="p">)</span>
    <span class="n">reporter</span><span class="o">.</span><span class="n">stories_filed</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">reporter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">print</span> <span class="n">connection</span><span class="o">.</span><span class="n">queries</span>

    <span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">F</span>
    <span class="n">reporter1</span> <span class="o">=</span> <span class="n">Reporters</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Tintin&#39;</span><span class="p">)</span>
    <span class="n">reporter1</span><span class="o">.</span><span class="n">stories_filed</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="s1">&#39;stories_filed&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">reporter1</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">print</span> <span class="n">connection</span><span class="o">.</span><span class="n">queries</span>
    <span class="c1"># ...</span>




<span class="c1"># urls.py</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^test/test/&#39;</span><span class="p">,</span> <span class="s1">&#39;diveinto_f&#39;</span><span class="p">),</span></code></pre></figure>

<p>在运行diveinto_f前，数据库中的name为Tintin的记录中stories_filed的值为6，记录之，然后跑一遍diveinto_f，将print的两组值copy出来，去掉前面django自带的一些sql语句，然后对比两次的save语句的sql如下：</p>

<pre><code>[{u'time': u'0.001', u'sql': u"SELECT `credit_reporters`.`id`, `credit_reporters`.`name`, `credit_reporters`.`stories_filed` FROM `credit_reporters` WHERE `credit_reporters`.`name` = 'Tintin' "}, {u'time': u'0.001', u'sql': u'SELECT (1) AS `a` FROM `credit_reporters` WHERE `credit_reporters`.`id` = 1  LIMIT 1'}, {u'time': u'0.000', u'sql': u"UPDATE `credit_reporters` SET `name` = 'Tintin', `stories_filed` = 7 WHERE `credit_reporters`.`id` = 1 "}]

[{u'time': u'0.001', u'sql': u"SELECT `credit_reporters`.`id`, `credit_reporters`.`name`, `credit_reporters`.`stories_filed` FROM `credit_reporters` WHERE `credit_reporters`.`name` = 'Tintin' "}, {u'time': u'0.000', u'sql': u'SELECT (1) AS `a` FROM `credit_reporters` WHERE `credit_reporters`.`id` = 1  LIMIT 1'}, {u'time': u'0.001', u'sql': u"UPDATE `credit_reporters` SET `name` = 'Tintin', `stories_filed` = `credit_reporters`.`stories_filed` + 1 WHERE `credit_reporters`.`id` = 1 "}]
</code></pre>

<p>可以清楚地看到，前面的select语句是一样的，但是最后的UPDATE的SET语言开始不同了，没有用到 F 函数的地方，是直接将运算的结果（即7）存入了数据库，而用到了 F 函数的地方，却是从数据库获取stories_filed的最新值，然后加1，差别就在这里了，就像官方文档说的，</p>

<blockquote>
  <p>An F() object represents the value of a model field. It makes it possible to refer to model field values and perform database operations using them without actually having to pull them out of the database into Python memory.</p>
</blockquote>

<blockquote>
  <p>Instead, Django uses the F() object to generate a SQL expression that describes the required operation at the database level</p>
</blockquote>

<p>大意就是说，F 函数使得可以在数据库层面上直接进行操作，而不是把数据库放到python内存中再进行操作。</p>

<p>参考资料：</p>

<p>[1].https://docs.djangoproject.com/en/dev/ref/models/queries/#django.db.models.F
[2].https://docs.djangoproject.com/en/dev/faq/models/#how-can-i-see-the-raw-sql-queries-django-is-running</p>

    <hr>
    <div class="pagination btn-group">
      
        <a class="btn prev" href="/blog/tech_world/ubuntu-java-awt-drawstring-chinese/" title="ubuntu上JAVA中awt的drawString方法无法写入中文">&larr; Previous</a>
      
        <a class="btn" href="/archive.html">Archive</a>
      
        <a class="btn next" href="/blog/tech_world/django-aggregate-annotate-e8-af-a6-e8-a7-a3/" title="Django aggregate annotate 详解">Next &rarr;</a>
      
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    
    var disqus_developer = 1;
    var disqus_shortname = 'shellbye'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
  
  <div class="span4">
    <section>
      <h4>Published</h4>
      <div class="date"><span>29 May 2014</span></div>
           
    </section>
    
      <section>
        <h4>Category</h4>
        
        <span class="category">
          tech_world
        </span>
        
      </section>
         
    
      <section>
        <h4>Tags</h4>
        <ul class="tag_box">
          
          


  
     
    	<li><a href="/tags.html#database-ref">database <span>1</span></a></li>
     
    	<li><a href="/tags.html#Django-ref">Django <span>17</span></a></li>
     
    	<li><a href="/tags.html#Python-ref">Python <span>14</span></a></li>
    
  



        </ul>
      </section>
             
  </div>
</div>


        </div>
      </div> <!-- /container -->

      <div class="footer-push"></div>
    </div><!--/.page-wrap -->

    <footer>
      <div class="container">
        <p>&copy; 2018 shellbye
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://github.com/dhulihan/hooligan" target="_blank">The Hooligan Theme</a>
        </p>
      </div>
    </footer>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="/assets/themes/hooligan/js/jquery.min.js"><\/script>')</script>
    <script src="/assets/themes/hooligan/bootstrap/js/bootstrap.min.js"></script>

    



  </body>
</html>

