

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>
      
        Python 爬虫示例 -
      
      六系小白
    </title>
    
    <meta name="author" content="shellbye">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link href="/assets/themes/hooligan/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/hooligan/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/assets/themes/hooligan/css-social-buttons/css/zocial.stripped.css">
    <link href="/assets/themes/hooligan/css/pygments.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/darkstrap.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link rel="shortcut icon" href="/assets/favicon.png">
    <link rel="apple-touch-icon" href="/assets/favicon.png">
    <!-- fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->
  </head>

  <body>
    <div id="page-wrap">
      <div class="navbar">
        <div class="navbar-inner">
          <div class="container">
            <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </a>

            <a class="brand" href="/">六系小白</a>

            <div class="nav-collapse">
              <ul class="nav">
                
                
                


  
    
      
      	
      	<li><a href="/archive/">历史记录</a></li>
      	
      
    
  
    
  
    
      
      	
      	<li><a href="/categories/">分类</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/blog/direct-era/">导演时代</a></li>
      	
      
    
  
    
      
    
  
    
  
    
      
      	
      	<li><a href="/blog/poet/">小白的诗</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/blog/small-games/">小游戏</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/tags/">标签</a></li>
      	
      
    
  
    
  
    
  



              </ul>
              <ul class="nav pull-right social visible-desktop">
                <li class="divider-vertical"></li>
                
                <li>
                  <a href="https://github.com/shellbye" class="zocial github icon" target="_blank">
                    <span class="hidden-desktop">Github</span>
                  </a>
                </li>
                
                
                
                
                
                
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="container">
        <div class="content">
          

<div class="page-header">
  <h1>
    Python 爬虫示例 
    
  </h1>
</div>

<div class="row">
  <div class="span8">
    <p>这是<a href="http://book.douban.com/subject/3112503/">《Python核心编程》</a>里的一个例子，我加了点注释帮助理解和记忆。Window7 和Ubuntu14.04都测试通过。</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding:utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">makedirs</span><span class="p">,</span> <span class="n">unlink</span><span class="p">,</span> <span class="n">sep</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">isdir</span><span class="p">,</span> <span class="n">exists</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">splitext</span><span class="p">,</span> <span class="n">abspath</span>
<span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">replace</span><span class="p">,</span> <span class="n">find</span><span class="p">,</span> <span class="n">lower</span>
<span class="kn">from</span> <span class="nn">htmllib</span> <span class="kn">import</span> <span class="n">HTMLParser</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">urljoin</span>
<span class="kn">from</span> <span class="nn">formatter</span> <span class="kn">import</span> <span class="n">DumbWriter</span><span class="p">,</span> <span class="n">AbstractFormatter</span>
<span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="k">class</span> <span class="nc">Retriever</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">deffile</span><span class="o">=</span><span class="s1">&#39;index.htm&#39;</span><span class="p">):</span>
        <span class="c1"># 使用http协议解析url地址，将url解析为这样的五元组：(scheme, netloc, path, query, fragment)</span>
        <span class="n">parsedurl</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s1">&#39;http:&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># 将主机地址（netloc）和路径（path）合并起来作为存储文件的路径名</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">parsedurl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">parsedurl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># splitext将path分割为路径与后缀名，如（/path/to/file, txt）</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="c1"># 如果后缀名为空，则给当前path添加默认的名字index.htm</span>
        <span class="k">if</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="c1"># 若path结尾有“/”则直接添加index.htm，否则先添加“/”</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">+=</span> <span class="n">deffile</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">deffile</span>
        <span class="c1"># 取出path中的目录部分（www.shellbye.com\\blog），然后与本地目录结合为一个目录(&#39;D:\\www.shellbye.com\\blog&#39;)</span>
        <span class="n">ldir</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="c1"># 如果不是以“/”作为目录分割符的类Unix系统，比如Windows，则需要把“”替换为相应的目录分割符</span>
        <span class="c1"># 因为类Unix系统的目录分割符与URI地址的分割符一样，所以可以不处理</span>
        <span class="k">if</span> <span class="n">sep</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>        <span class="c1"># os-indep. path separator</span>
            <span class="n">ldir</span> <span class="o">=</span> <span class="n">replace</span><span class="p">(</span><span class="n">ldir</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="p">)</span>
        <span class="c1"># 如果ldir目录不存在在创建</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">ldir</span><span class="p">):</span>      <span class="c1"># create archive dir if nec.</span>
            <span class="c1"># 如果ldir存在但是不是目录则删除ldir。注，unlink即remove。</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">ldir</span><span class="p">):</span>
                <span class="n">unlink</span><span class="p">(</span><span class="n">ldir</span><span class="p">)</span>
            <span class="n">makedirs</span><span class="p">(</span><span class="n">ldir</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        <span class="c1"># download Web page</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 下载self.url到self.file里</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;*** ERROR: invalid URL &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">retval</span>

    <span class="k">def</span> <span class="nf">parseAndGetLinks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 创建一个基本的HTML解释器，可能需要单独一篇文章来说这句</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">HTMLParser</span><span class="p">(</span><span class="n">AbstractFormatter</span><span class="p">(</span><span class="n">DumbWriter</span><span class="p">(</span><span class="n">StringIO</span><span class="p">())))</span>
        <span class="c1"># 解析html文件，获取所有的连接（带有href的）</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">anchorlist</span>

<span class="k">class</span> <span class="nc">Crawler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="n">url</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># 获取url的主机名，domain，即域名</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dom</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">getPage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Retriever</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="c1"># 下载一个url对应的页面，出错即返回</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">download</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">retval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>     <span class="c1"># error situation, do not parse</span>
            <span class="k">print</span> <span class="n">retval</span><span class="p">,</span> <span class="s1">&#39;... skipping parse&#39;</span>
            <span class="k">return</span>
        <span class="c1"># 爬取统计自增</span>
        <span class="n">Crawler</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">print</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">(&#39;</span><span class="p">,</span> <span class="n">Crawler</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span>
        <span class="k">print</span> <span class="s1">&#39;URL:&#39;</span><span class="p">,</span> <span class="n">url</span>
        <span class="c1"># 爬取到的文件的存储位置</span>
        <span class="k">print</span> <span class="s1">&#39;FILE:&#39;</span><span class="p">,</span> <span class="n">retval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># 加入已爬取队列</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="c1"># 将从新页面获取的link进行处理</span>
        <span class="n">links</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">parseAndGetLinks</span><span class="p">()</span>  <span class="c1"># get and process links</span>
        <span class="k">for</span> <span class="n">eachLink</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
            <span class="c1"># 当前link不是完整的url，则为其添加完整路径</span>
            <span class="k">if</span> <span class="n">eachLink</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;http&#39;</span> <span class="ow">and</span> <span class="n">find</span><span class="p">(</span><span class="n">eachLink</span><span class="p">,</span> <span class="s1">&#39;://&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">eachLink</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">eachLink</span><span class="p">)</span>
            <span class="k">print</span> <span class="s1">&#39;* &#39;</span><span class="p">,</span> <span class="n">eachLink</span><span class="p">,</span>
            <span class="c1"># 放弃mailto:式的连接</span>
            <span class="k">if</span> <span class="n">find</span><span class="p">(</span><span class="n">lower</span><span class="p">(</span><span class="n">eachLink</span><span class="p">),</span> <span class="s1">&#39;mailto:&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;... discarded, mailto link&#39;</span>
                <span class="k">continue</span>
            <span class="c1"># 对于没有处理过的link</span>
            <span class="k">if</span> <span class="n">eachLink</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">:</span>
                <span class="c1"># 外链不管</span>
                <span class="k">if</span> <span class="n">find</span><span class="p">(</span><span class="n">eachLink</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dom</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s1">&#39;... discarded, not in domain&#39;</span>
                <span class="c1"># 若已爬取则不处理，否则加入待爬取队列</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">eachLink</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eachLink</span><span class="p">)</span>
                        <span class="k">print</span> <span class="s1">&#39;... new, added to Q&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s1">&#39;... discarded, already in Q&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;... discarded, already processed&#39;</span>

    <span class="k">def</span> <span class="nf">go</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># 掌管整个爬取进程，依次从q中取出待爬取的link，然后去爬取</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getPage</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://shellbye.com&quot;</span>
    <span class="n">robot</span> <span class="o">=</span> <span class="n">Crawler</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">robot</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span></code></pre></figure>


    <hr>
    <div class="pagination btn-group">
      
        <a class="btn prev" href="/blog/tech_world/putty-e4-b8-ad-e6-97-a0-e6-b3-95-e4-bd-bf-e7-94-a8-byubo-e5-8a-9f-e8-83-bd-e9-94-ae/" title="putty 中无法使用 byubo 功能键">&larr; Previous</a>
      
        <a class="btn" href="/archive.html">Archive</a>
      
        <a class="btn next" href="/blog/tech_world/e3-80-8apython-e9-ab-98-e7-ba-a7-e7-bc-96-e7-a8-8b-e3-80-8b-e8-af-bb-e4-b9-a6-e7-ac-94-e8-ae-b0-ef-bc-881-ef-bc-89/" title="《Python 高级编程》读书笔记（1）">Next &rarr;</a>
      
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    
    var disqus_developer = 1;
    var disqus_shortname = 'shellbye'; // required: replace example with your forum shortname
    var disqus_identifier = '1015 http://shellbye.com/?p=1015';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
  
  <div class="span4">
    <section>
      <h4>Published</h4>
      <div class="date"><span>26 August 2014</span></div>
           
    </section>
    
      <section>
        <h4>Category</h4>
        
        <span class="category">
          tech_world
        </span>
        
      </section>
         
    
      <section>
        <h4>Tags</h4>
        <ul class="tag_box">
          
          


  
     
    	<li><a href="/tags.html#Python-ref">Python <span>14</span></a></li>
    
  



        </ul>
      </section>
             
  </div>
</div>


        </div>
      </div> <!-- /container -->

      <div class="footer-push"></div>
    </div><!--/.page-wrap -->

    <footer>
      <div class="container">
        <p>&copy; 2018 shellbye
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://github.com/dhulihan/hooligan" target="_blank">The Hooligan Theme</a>
        </p>
      </div>
    </footer>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="/assets/themes/hooligan/js/jquery.min.js"><\/script>')</script>
    <script src="/assets/themes/hooligan/bootstrap/js/bootstrap.min.js"></script>

    



  </body>
</html>

